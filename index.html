<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Chatbot Lyro - Fundaci√≥n Capac√≠tamente</title>

  <style>
    body { margin:0; padding:0; }

    #chat-toggle{
      position:fixed; bottom:20px; right:20px; padding:15px 20px;
      background:#1E90FF; color:#fff; border:none; border-radius:30px;
      cursor:pointer; z-index:10001; box-shadow:0 4px 12px rgba(0,0,0,.25);
      font-weight:bold; transition: transform .1s, filter .2s;
    }
    #chat-toggle:hover{ filter:brightness(.97); transform: translateY(-2px); }

    #whatsapp-toggle{
      position:fixed; bottom:20px; right:200px;
      width:56px; height:56px;
      background:#25D366; border-radius:50%;
      cursor:pointer; z-index:10001;
      box-shadow:0 4px 12px rgba(0,0,0,.25);
      text-decoration:none;
      display:inline-flex; align-items:center; justify-content:center;
      transition: transform .1s, filter .2s;
    }
    #whatsapp-toggle:hover{ filter:brightness(.97); transform: translateY(-2px); }

    .wa-icon{
      width:28px; height:28px;
      background-repeat:no-repeat;
      background-position:center;
      background-size:contain;
      background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Cpath fill='%23fff' d='M19.11 17.53c-.27-.13-1.6-.79-1.85-.88-.25-.09-.43-.13-.61.13-.18.27-.7.88-.86 1.06-.16.18-.32.2-.59.07-.27-.13-1.14-.42-2.17-1.34-.8-.71-1.34-1.59-1.5-1.86-.16-.27-.02-.41.12-.55.12-.12.27-.32.41-.48.14-.16.18-.27.27-.45.09-.18.04-.34-.02-.48-.07-.13-.61-1.47-.84-2.01-.22-.53-.45-.46-.61-.47h-.52c-.18 0-.48.07-.73.34-.25.27-.95.93-.95 2.28 0 1.35.98 2.65 1.11 2.83.13.18 1.93 2.95 4.68 4.13.65.28 1.16.45 1.56.57.65.21 1.24.18 1.71.11.52-.08 1.6-.65 1.82-1.28.23-.63.23-1.17.16-1.28-.07-.11-.25-.18-.52-.32z'/%3E%3Cpath fill='%23fff' d='M26.66 5.34A14.9 14.9 0 0016.04.99C7.86.99 1.2 7.64 1.2 15.82c0 2.62.69 5.18 2 7.44L1.08 31l7.9-2.07a14.8 14.8 0 007.06 1.8h.01c8.18 0 14.84-6.65 14.84-14.83 0-3.96-1.55-7.69-4.23-10.56zM16.04 28.2h-.01a12.3 12.3 0 01-6.28-1.72l-.45-.27-4.69 1.23 1.25-4.57-.29-.47a12.3 12.3 0 01-1.89-6.58c0-6.79 5.52-12.31 12.32-12.31a12.24 12.24 0 018.72 3.62 12.25 12.25 0 013.6 8.69c0 6.79-5.52 12.31-12.28 12.38z'/%3E%3C/svg%3E");
    }

    #chat-container{
      position:fixed; bottom:80px; right:20px;
      width:350px; height:450px;
      max-width:92vw; max-height:75vh;
      background:#fff; border-radius:12px;
      box-shadow:0 8px 30px rgba(0,0,0,.3);
      z-index:10000; display:none; flex-direction:column; overflow:hidden;
      font-family:Arial, sans-serif;
    }

    #chat-header{
      background:#1E90FF; color:#fff; padding:15px; text-align:center;
      font-weight:bold; font-size:1.05em;
    }

    #chat-messages{
      flex-grow:1; padding:10px; overflow-y:auto; background:#F4F7F9;
      display:flex; flex-direction:column;
    }

    .message{
      padding:8px 12px; margin-bottom:10px; border-radius:18px;
      max-width:80%; line-height:1.4; word-wrap:break-word;
      white-space:pre-wrap;
    }
    .user{ background:#DCF8C6; align-self:flex-end; margin-left:auto; }
    .bot{ background:#fff; align-self:flex-start; margin-right:auto; border:1px solid #E0E0E0; }

    #suggestion-buttons{
      padding:10px; background:#F4F7F9; display:flex; flex-wrap:wrap; gap:5px;
      border-top:1px solid #eee;
    }
    .suggestion{
      background:#fff; color:#1E90FF; border:1px solid #1E90FF;
      padding:8px 12px; border-radius:20px; cursor:pointer; font-size:.85em;
      transition: background-color .2s, color .2s;
    }
    .suggestion:hover{ background:#1E90FF; color:#fff; }

    #chat-input-area{ display:flex; padding:10px; border-top:1px solid #eee; background:#fff; }
    #chat-input{ flex-grow:1; padding:10px; border:1px solid #E0E0E0; border-radius:20px; margin-right:8px; font-size:1em; outline:none; }
    #send-button{ background:#1E90FF; color:#fff; border:none; border-radius:20px; padding:10px 15px; font-weight:bold; cursor:pointer; }
    #send-button:disabled{ opacity:.7; cursor:not-allowed; }
  </style>
</head>

<body>
  <button id="chat-toggle">ü§ñ Chatea con Lyro</button>

  <a id="whatsapp-toggle" href="https://wa.me/593991667561" target="_blank" rel="noopener noreferrer" aria-label="WhatsApp">
    <span class="wa-icon" aria-hidden="true"></span>
  </a>

  <div id="chat-container">
    <div id="chat-header">Lyro-Capac√≠tamente (Asistente IA)</div>

    <div id="chat-messages"></div>

    <div id="suggestion-buttons">
      <button class="suggestion" data-text="Cursos gratis">Cursos gratis</button>
      <button class="suggestion" data-text="Cursos con certificados y precios">Cursos con certificados y precios</button>
      <button class="suggestion" data-text="Contacto">Contacto</button>
      <button class="suggestion" data-text="Donar">Donar</button>
    </div>

    <div id="chat-input-area">
      <input type="text" id="chat-input" placeholder="Escribe tu pregunta...">
      <button id="send-button">Enviar</button>
    </div>
  </div>

  <script>
    const SERVER_URL = "https://lyro-chatbot-capacitamente.onrender.com";

    // userKey an√≥nimo (NO secreto)
    let userKey = localStorage.getItem("lyroUserKey");
    if (!userKey) {
      userKey = "user_" + Date.now() + "_" + Math.random().toString(36).slice(2, 10);
      localStorage.setItem("lyroUserKey", userKey);
    }

    // sessionId persistente
    let currentSessionId = localStorage.getItem("chatSessionId");
    if (!currentSessionId) {
      currentSessionId = "session-" + Date.now() + "-" + Math.random().toString(36).slice(2, 10);
      localStorage.setItem("chatSessionId", currentSessionId);
    }

    const toggleButton = document.getElementById("chat-toggle");
    const chatContainer = document.getElementById("chat-container");
    const sendButton = document.getElementById("send-button");
    const chatInput = document.getElementById("chat-input");
    const chatMessages = document.getElementById("chat-messages");
    const suggestionButtons = document.querySelectorAll("#suggestion-buttons .suggestion");

    function addMessage(text, sender) {
      const msg = document.createElement("div");
      msg.className = "message " + sender;
      msg.textContent = text;
      chatMessages.appendChild(msg);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function clearMessages() {
      chatMessages.innerHTML = "";
    }

    async function loadHistory() {
      try {
        const r = await fetch(`${SERVER_URL}/history/${encodeURIComponent(currentSessionId)}?limit=200`);
        const raw = await r.text();
        const data = JSON.parse(raw);

        if (!r.ok) throw new Error((data && (data.details || data.error)) || raw);

        if (Array.isArray(data.messages) && data.messages.length > 0) {
          clearMessages();
          for (const m of data.messages) {
            addMessage(m.content, m.role === "user" ? "user" : "bot");
          }
        } else {
          // si no hay historial, mensaje inicial
          if (chatMessages.children.length === 0) {
            addMessage("Hola, soy Lyro-Capac√≠tamente. ¬øEn qu√© puedo ayudarte hoy?", "bot");
          }
        }
      } catch (e) {
        console.error("Historial error:", e);
        if (chatMessages.children.length === 0) {
          addMessage("Hola, soy Lyro-Capac√≠tamente. (No pude cargar el historial ahora). ¬øEn qu√© te ayudo?", "bot");
        }
      }
    }

    async function sendMessage(textFromBtn = null) {
      const rawText = (textFromBtn ? textFromBtn : (chatInput.value || "")).trim();
      if (!rawText) return;

      addMessage(rawText, "user");
      chatInput.value = "";

      chatInput.disabled = true;
      sendButton.disabled = true;
      sendButton.textContent = "Cargando...";

      try {
        const response = await fetch(SERVER_URL + "/chat", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            message: rawText,
            sessionId: currentSessionId,
            userKey: userKey
          })
        });

        const raw = await response.text();
        const data = JSON.parse(raw);

        if (!response.ok) throw new Error(data.reply || raw);

        if (data.sessionId && data.sessionId !== currentSessionId) {
          currentSessionId = data.sessionId;
          localStorage.setItem("chatSessionId", currentSessionId);
        }

        addMessage(data.reply || "Sin respuesta.", "bot");
      } catch (err) {
        console.error(err);
        addMessage("Lo siento, estoy teniendo problemas de conexi√≥n. Intenta m√°s tarde.", "bot");
      } finally {
        chatInput.disabled = false;
        sendButton.disabled = false;
        sendButton.textContent = "Enviar";
        chatInput.focus();
      }
    }

    toggleButton.onclick = async () => {
      const isVisible = chatContainer.style.display === "flex";
      chatContainer.style.display = isVisible ? "none" : "flex";

      if (!isVisible) {
        fetch(SERVER_URL + "/health").catch(()=>{});
        await loadHistory();
        setTimeout(() => chatInput.focus(), 100);
      }
    };

    sendButton.onclick = () => sendMessage();
    chatInput.addEventListener("keypress", (event) => {
      if (event.key === "Enter") {
        event.preventDefault();
        sendMessage();
      }
    });

    suggestionButtons.forEach(btn => {
      btn.addEventListener("click", () => sendMessage(btn.getAttribute("data-text")));
    });
  </script>
</body>
</html>
