<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Lyro Widget Test</title>
  <style>
    *{ box-sizing:border-box; font-family:Arial, sans-serif; }
    body{ margin:0; padding:0; min-height:100vh; background:#0b1220; color:#e5e7eb; }
    .page{
      max-width:1100px; margin:0 auto; padding:24px;
    }
    .card{
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.1);
      border-radius:16px;
      padding:18px;
      box-shadow:0 10px 30px rgba(0,0,0,.35);
    }

    /* Toggle */
    #chat-toggle{
      position:fixed; bottom:20px; right:20px;
      padding:14px 18px; border:none; border-radius:999px;
      cursor:pointer; z-index:10001;
      background:#1E90FF; color:#fff; font-weight:800;
      box-shadow:0 10px 26px rgba(0,0,0,.35);
    }

    /* Chat container */
    #chat-container{
      position:fixed; bottom:80px; right:20px;
      width:380px; height:680px;
      max-width:92vw; max-height:85vh;
      background:#fff; color:#111827;
      border-radius:16px;
      box-shadow:0 18px 60px rgba(0,0,0,.45);
      z-index:10000; display:none;
      overflow:hidden;
      display:flex; flex-direction:column;
    }

    /* Header */
    #chat-header{
      background:#1E90FF; color:#fff;
      padding:10px 12px;
      display:flex; align-items:center; justify-content:space-between;
      gap:10px;
    }
    #chat-title{ font-weight:900; max-width:220px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    .hbtn{
      border:none; cursor:pointer;
      border-radius:10px;
      padding:8px 10px;
      background:rgba(255,255,255,.18);
      color:#fff; font-weight:800;
    }

    /* Drawer historial */
    #history-drawer{
      position:absolute; top:0; left:0; bottom:0;
      width:78%;
      background:#0f172a; color:#e5e7eb;
      z-index:10002;
      transform: translateX(-105%);
      transition: transform .18s ease;
      display:flex; flex-direction:column;
      border-right:1px solid rgba(255,255,255,.08);
    }
    #history-drawer.open{ transform: translateX(0); }
    #history-top{
      padding:12px;
      display:flex; align-items:center; justify-content:space-between;
      border-bottom:1px solid rgba(255,255,255,.08);
      gap:10px;
    }
    #history-list{
      overflow:auto; padding:10px;
      display:flex; flex-direction:column; gap:8px;
    }
    .day-sep{
      margin:10px 0 2px;
      font-size:.82em;
      opacity:.8;
    }
    .session-item{
      position:relative;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);
      color:#e5e7eb;
      border-radius:12px;
      padding:10px;
      cursor:pointer;
    }
    .session-item.active{
      border-color:rgba(59,130,246,.9);
      box-shadow:0 0 0 1px rgba(59,130,246,.45) inset;
    }
    .session-item .meta{ font-size:.78em; opacity:.85; margin-bottom:6px; display:flex; gap:8px; align-items:center; }
    .session-item .preview{ font-size:.9em; line-height:1.25; opacity:.95; word-break:break-word; }
    .history-more{
      position:absolute; top:8px; right:6px;
      width:28px; height:28px;
      border-radius:8px;
      border:none;
      background:transparent;
      color:#94a3b8;
      cursor:pointer;
      font-size:16px;
      display:flex; align-items:center; justify-content:center;
      z-index:20;
    }
    .history-more:hover{ background:rgba(255,255,255,.15); color:#fff; }
    .history-menu{
      display:none;
      position:absolute; top:38px; right:8px;
      background:#1e293b;
      border:1px solid #334155;
      border-radius:10px;
      padding:4px;
      min-width:160px;
      box-shadow:0 12px 30px rgba(0,0,0,0.6);
      z-index:50;
    }
    .history-menu button{
      width:100%;
      text-align:left;
      background:transparent;
      border:none;
      color:#cbd5e1;
      padding:8px 10px;
      font-size:13px;
      cursor:pointer;
      border-radius:6px;
      display:flex; align-items:center; gap:6px;
    }
    .history-menu button:hover{ background:#334155; color:#fff; }
    .history-menu .danger{ color:#f87171; }
    .history-menu .danger:hover{ background:rgba(248,113,113,0.15); }

    /* Messages */
    #chat-messages{
      flex:1;
      padding:10px;
      overflow:auto;
      background:#F4F7F9;
      display:flex;
      flex-direction:column;
    }
    .message{
      padding:8px 12px;
      margin-bottom:10px;
      border-radius:18px;
      max-width:80%;
      line-height:1.35;
      white-space:pre-wrap;
      word-break:break-word;
    }
    .user{ background:#DCF8C6; align-self:flex-end; margin-left:auto; }
    .bot{ background:#fff; align-self:flex-start; margin-right:auto; border:1px solid #E5E7EB; }
    .time{ display:block; font-size:.72em; opacity:.65; margin-top:4px; }

    /* ‚úÖ botones NO se tapan */
    #suggestion-buttons{
      padding:10px;
      background:#F4F7F9;
      border-top:1px solid #e5e7eb;
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      max-height:110px;
      overflow:auto;
    }
    .suggestion{
      background:#fff;
      color:#1E90FF;
      border:1px solid #1E90FF;
      padding:8px 12px;
      border-radius:999px;
      cursor:pointer;
      font-size:.85em;
      font-weight:700;
    }
    .suggestion:hover{ background:#1E90FF; color:#fff; }

    /* Input */
    #chat-input-area{
      display:flex;
      padding:10px;
      border-top:1px solid #e5e7eb;
      background:#fff;
    }
    #chat-input{
      flex:1;
      padding:10px 12px;
      border:1px solid #e5e7eb;
      border-radius:999px;
      outline:none;
      font-size:1em;
    }
    #send-button{
      margin-left:8px;
      border:none;
      border-radius:999px;
      background:#1E90FF;
      color:#fff;
      font-weight:900;
      padding:10px 14px;
      cursor:pointer;
    }
    #send-button:disabled{ opacity:.7; cursor:not-allowed; }
  </style>
</head>
<body>
  <div class="page">
    <div class="card">
      <h2 style="margin:0 0 10px;">Test local del Chatbot Lyro</h2>
      <p style="margin:0;opacity:.9;">
        Abre el chat con el bot√≥n flotante. Aqu√≠ pruebas historial, fijar (pin) y horarios guardados.
      </p>
    </div>
  </div>

  <button id="chat-toggle">ü§ñ Chatea con Lyro</button>

  <div id="chat-container">
    <div id="history-drawer">
      <div id="history-top">
        <b>üìö Historial</b>
        <button class="hbtn" id="history-close">‚úï</button>
      </div>
      <div id="history-list"></div>
    </div>

    <div id="chat-header">
      <div style="display:flex;align-items:center;gap:8px;">
        <button class="hbtn" id="history-open">‚ò∞</button>
        <div id="chat-title">Lyro-Capac√≠tamente</div>
      </div>
      <button class="hbtn" id="new-chat">Ôºã Nueva</button>
    </div>

    <div id="chat-messages"></div>

    <div id="suggestion-buttons"></div>

    <div id="chat-input-area">
      <input id="chat-input" type="text" placeholder="Escribe tu pregunta..." />
      <button id="send-button">Enviar</button>
    </div>
  </div>

<script>
  const SERVER_URL = "https://lyro-chatbot-capacitamente.onrender.com";

  // clientId persistente
  const CLIENT_ID_KEY = "lyroClientId";
  let clientId = localStorage.getItem(CLIENT_ID_KEY);
  if (!clientId) {
    clientId = (crypto.randomUUID ? crypto.randomUUID() : ("cid-" + Date.now() + "-" + Math.random().toString(36).slice(2)));
    localStorage.setItem(CLIENT_ID_KEY, clientId);
  }

  const SESSION_KEY = "chatSessionId";
  let currentSessionId = localStorage.getItem(SESSION_KEY) || "";

  const toggleButton = document.getElementById("chat-toggle");
  const chatContainer = document.getElementById("chat-container");
  const sendButton = document.getElementById("send-button");
  const chatInput = document.getElementById("chat-input");
  const chatMessages = document.getElementById("chat-messages");

  const historyDrawer = document.getElementById("history-drawer");
  const historyOpen = document.getElementById("history-open");
  const historyClose = document.getElementById("history-close");
  const historyList = document.getElementById("history-list");
  const newChatBtn = document.getElementById("new-chat");

  const suggestionsEl = document.getElementById("suggestion-buttons");

  function fmtDate(d) {
    return new Date(d).toLocaleDateString("es-EC", { year:"numeric", month:"2-digit", day:"2-digit" });
  }
  function fmtTime(d) {
    return new Date(d).toLocaleTimeString("es-EC", { hour:"2-digit", minute:"2-digit" });
  }

  function clearMessages(){ chatMessages.innerHTML = ""; }

  function addMessage(text, sender, createdAt=null){
    const msg = document.createElement("div");
    msg.className = "message " + sender;

    const content = document.createElement("div");
    content.textContent = text;

    const time = document.createElement("span");
    time.className = "time";
    time.textContent = createdAt ? (fmtDate(createdAt) + " " + fmtTime(createdAt)) : fmtTime(Date.now());

    msg.appendChild(content);
    msg.appendChild(time);

    chatMessages.appendChild(msg);
    chatMessages.scrollTop = chatMessages.scrollHeight;
  }

  function roleToSender(role){
    const r = String(role || "").toLowerCase();
    return (r.includes("user") || r.includes("usuario")) ? "user" : "bot";
  }

  async function apiFetch(path, opts = {}) {
    const headers = Object.assign(
      { "Content-Type": "application/json", "x-client-id": clientId },
      (opts.headers || {})
    );

    const res = await fetch(SERVER_URL + path, { ...opts, headers });
    const txt = await res.text();
    let json = null;
    try { json = JSON.parse(txt); } catch {}

    if (!res.ok) {
      const msg = (json && (json.error || json.reply)) ? (json.error || json.reply) : txt;
      throw new Error("HTTP " + res.status + ": " + msg);
    }
    return json ?? {};
  }

  function renderSuggestions(suggestions){
    suggestionsEl.innerHTML = "";
    const list = Array.isArray(suggestions) ? suggestions : [];

    // fallback m√≠nimo
    const fallback = [
      { text:"menu", label:"üìå Men√∫" },
      { text:"1", label:"1) Cursos gratis" },
      { text:"2", label:"2) Certificados y precios" },
      { text:"3", label:"3) Contacto" },
      { text:"6", label:"6) Horarios" }
    ];

    (list.length ? list : fallback).forEach(s => {
      const b = document.createElement("button");
      b.className = "suggestion";
      b.textContent = s.label || s.text;
      b.addEventListener("click", () => sendMessage(String(s.text || "")));
      suggestionsEl.appendChild(b);
    });
  }

  async function ensureCurrentSession() {
    if (currentSessionId) return currentSessionId;
    const s = await apiFetch("/sessions", { method:"POST", body: JSON.stringify({ clientId }) });
    currentSessionId = s.sessionId;
    localStorage.setItem(SESSION_KEY, currentSessionId);
    return currentSessionId;
  }

  async function loadHistory(sessionId){
    clearMessages();
    await ensureCurrentSession();

    const data = await apiFetch(`/history/${encodeURIComponent(currentSessionId)}?limit=300`, { method:"GET" });
    const msgs = data.messages || [];

    if (!msgs.length) {
      addMessage("Hola, soy Lyro-Capac√≠tamente. Escribe MENU para ver opciones.", "bot", new Date().toISOString());
      renderSuggestions([{text:"menu",label:"üìå Men√∫"}]);
      return;
    }

    for (const m of msgs) addMessage(m.content || "", roleToSender(m.role), m.created_at);

    // Por defecto, siempre te muestro men√∫ como ayuda
    renderSuggestions([{text:"menu",label:"üìå Men√∫"}]);
  }

  async function loadSessionsList(){
    const data = await apiFetch("/sessions?limit=60", { method:"GET" });
    const sessions = data.sessions || [];
    historyList.innerHTML = "";

    if (!sessions.length) {
      const empty = document.createElement("div");
      empty.style.opacity = "0.8";
      empty.style.fontSize = "0.9em";
      empty.style.padding = "10px";
      empty.textContent = "A√∫n no hay conversaciones. Pulsa ‚ÄúNueva‚Äù.";
      historyList.appendChild(empty);
      return;
    }

    const pinnedSessions = sessions.filter(s => s.pinned);
    const normalSessions = sessions.filter(s => !s.pinned);

    if (pinnedSessions.length) {
      const sep = document.createElement("div");
      sep.className = "day-sep";
      sep.textContent = "üìå FIJADAS";
      historyList.appendChild(sep);
      pinnedSessions.forEach(s => renderItem(s, true));
    }

    const groups = {};
    for (const s of normalSessions) {
      const stamp = s.last_message_at || s.created_at || Date.now();
      const day = fmtDate(stamp);
      if (!groups[day]) groups[day] = [];
      groups[day].push(s);
    }

    const orderedDays = Object.keys(groups).sort((a,b) => {
      const pa = a.split("/").reverse().join("-");
      const pb = b.split("/").reverse().join("-");
      return pb.localeCompare(pa);
    });

    orderedDays.forEach(day => {
      const sep = document.createElement("div");
      sep.className = "day-sep";
      sep.textContent = "üìÖ " + day;
      historyList.appendChild(sep);

      groups[day].forEach(s => renderItem(s, false));
    });

    function renderItem(s, isPinned){
      const stamp = s.last_message_at || s.created_at || Date.now();
      const num = (typeof s.conversation_number !== "undefined" && s.conversation_number !== null)
        ? s.conversation_number
        : "";
      const label = `${isPinned ? "üìå " : ""}Conversaci√≥n ${num ? ("#" + num) : ""}`.trim();

      const itemDiv = document.createElement("div");
      itemDiv.className = "session-item" + (s.session_id === currentSessionId ? " active" : "");
      itemDiv.dataset.session = s.session_id;
      itemDiv.dataset.pinned = isPinned ? "1" : "0";

      const preview = (s.last_message_preview || "Conversaci√≥n nueva").replace(/</g,"&lt;");

      itemDiv.innerHTML = `
        <div class="meta">üïí ${fmtTime(stamp)} <span style="opacity:.7;">‚Ä¢</span> <span>${label}</span></div>
        <div class="preview">${preview}</div>

        <button class="history-more" type="button" title="Opciones">‚ãØ</button>
        <div class="history-menu">
          <button class="history-pin" type="button">${isPinned ? "üìå Desfijar" : "üìå Fijar"}</button>
          <button class="history-delete danger" type="button">üóëÔ∏è Eliminar</button>
        </div>
      `;

      historyList.appendChild(itemDiv);
    }
  }

  document.addEventListener("click", (e) => {
    if (!e.target.closest(".session-item")) {
      document.querySelectorAll(".history-menu").forEach(m => m.style.display = "none");
    }
  });

  historyList.addEventListener("click", async (e) => {
    const item = e.target.closest(".session-item");
    if (!item) return;

    const sid = item.getAttribute("data-session");

    // abrir men√∫ ‚ãØ
    if (e.target.closest(".history-more")) {
      e.stopPropagation();
      document.querySelectorAll(".history-menu").forEach(m => m.style.display = "none");
      const menu = item.querySelector(".history-menu");
      menu.style.display = (menu.style.display === "block") ? "none" : "block";
      return;
    }

    // fijar
    if (e.target.closest(".history-pin")) {
      e.stopPropagation();
      document.querySelectorAll(".history-menu").forEach(m => m.style.display = "none");
      const currentlyPinned = item.dataset.pinned === "1";
      const newPinned = !currentlyPinned;

      await apiFetch(`/session/${encodeURIComponent(sid)}/pin`, {
        method:"PATCH",
        body: JSON.stringify({ pinned: newPinned })
      });

      await loadSessionsList();
      return;
    }

    // eliminar
    if (e.target.closest(".history-delete")) {
      e.stopPropagation();
      document.querySelectorAll(".history-menu").forEach(m => m.style.display = "none");
      if (!confirm("¬øEliminar esta conversaci√≥n?")) return;

      await apiFetch(`/session/${encodeURIComponent(sid)}`, { method:"DELETE" });

      if (sid === currentSessionId) {
        currentSessionId = "";
        localStorage.removeItem(SESSION_KEY);
        clearMessages();
        addMessage("Conversaci√≥n eliminada. Pulsa ‚ÄúNueva‚Äù para crear otra.", "bot", new Date().toISOString());
      }

      await loadSessionsList();
      return;
    }

    // seleccionar conversaci√≥n
    if (!e.target.closest(".history-menu")) {
      currentSessionId = sid;
      localStorage.setItem(SESSION_KEY, currentSessionId);
      await loadHistory(currentSessionId);
      await loadSessionsList();
      historyDrawer.classList.remove("open");
    }
  });

  async function newConversation(){
    const s = await apiFetch("/sessions", { method:"POST", body: JSON.stringify({ clientId }) });
    currentSessionId = s.sessionId;
    localStorage.setItem(SESSION_KEY, currentSessionId);
    await loadHistory(currentSessionId);
    await loadSessionsList();
  }

  async function sendMessage(textFromButton=null){
    const rawText = textFromButton ? String(textFromButton) : (chatInput.value || "").trim();
    if (!rawText) return;

    addMessage(rawText, "user", new Date().toISOString());
    chatInput.value = "";

    chatInput.disabled = true;
    sendButton.disabled = true;
    sendButton.textContent = "Cargando...";

    try {
      await ensureCurrentSession();

      const data = await apiFetch("/chat", {
        method:"POST",
        body: JSON.stringify({
          message: rawText,
          sessionId: currentSessionId,
          clientId
        })
      });

      if (data.sessionId && data.sessionId !== currentSessionId) {
        currentSessionId = data.sessionId;
        localStorage.setItem(SESSION_KEY, currentSessionId);
      }

      addMessage(data.reply || "Sin respuesta.", "bot", new Date().toISOString());
      renderSuggestions(data.suggestions);

      await loadSessionsList();
    } catch (err) {
      addMessage("Error de conexi√≥n: " + err.message, "bot", new Date().toISOString());
      renderSuggestions([{text:"menu",label:"üìå Men√∫"}]);
    } finally {
      chatInput.disabled = false;
      sendButton.disabled = false;
      sendButton.textContent = "Enviar";
      chatInput.focus();
    }
  }

  toggleButton.onclick = async () => {
    const isVisible = chatContainer.style.display === "flex";
    chatContainer.style.display = isVisible ? "none" : "flex";

    if (!isVisible) {
      await apiFetch("/health", { method:"GET" }).catch(()=>{});
      await ensureCurrentSession();
      await loadSessionsList();
      await loadHistory(currentSessionId);
      renderSuggestions([{text:"menu",label:"üìå Men√∫"}]);
      setTimeout(() => chatInput.focus(), 80);
    }
  };

  sendButton.onclick = () => sendMessage();

  chatInput.addEventListener("keypress", (e) => {
    if (e.key === "Enter") {
      e.preventDefault();
      sendMessage();
    }
  });

  historyOpen.onclick = () => historyDrawer.classList.add("open");
  historyClose.onclick = () => historyDrawer.classList.remove("open");
  newChatBtn.onclick = () => newConversation();

  // iniciar sugerencias base
  renderSuggestions([{text:"menu",label:"üìå Men√∫"}, {text:"1",label:"1) Cursos gratis"}, {text:"2",label:"2) Certificados y precios"}]);
</script>
</body>
</html>
